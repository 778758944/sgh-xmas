# SunGlassHut 2015 圣诞节游戏项目
# 开发者说明文档
#
# Version 1.0.0-CN
# 上一次更新: 17 Dec 2015
# INZEN
===============================================================

# 1. 前言
===============================================================
本项目的后台是使用NodeJS+Loopback模组建立游戏的前后端，并使用
MongoDB来负责储存数据。

部署本项目前请检查服务器环境已经安装以下软件：
- Node
- MongoDB
缺乏其中一种软件将不能运行服务器。

部署后初期运行前，请在服务端运行npm install命令，以安装必须的
Node插件
===============================================================

# 2. 后台端口 =================================================

2.1 使用者登陆 (给所有游戏玩家)

---POST /user/register-----------------------------------------
说明	: 注册新玩家。 
方式	: POST (x-www-urlencoded)
输入	: 
{
	'openID'	: (String) 微信用户识别码
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 命令执行失败时的信息
	'data'		: (JSONObject) *注：在'success'为true时才会有
	{
		'chances' : (Number) 剩余游戏机会，初始为1。
	}
}

----------------------------------------------------------------

---POST /user/remainingChances ---------------------------------
说明	: 检查玩家剩下的机会
方式	: POST (x-www-urlencoded)
输入	: 
{
	'openID'	: (String) 微信用户识别码
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 命令执行失败时的信息
	'data'		: (JSONObject) *注：在'success'为true时才会有
	{
		'chances' : (Number) 剩余机会。
	}
}

----------------------------------------------------------------

---POST /user/setChances ---------------------------------------
说明	: 设置玩家的机会数量。（将会覆盖目前玩家剩余的机会）
方式	: POST (x-www-urlencoded)
输入	: 
{
	'openID'	: (String) 微信用户识别码
	'chances'	: (Number) 要设置的机会数量
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 命令执行失败时的信息
	'data'		: --空--
}
----------------------------------------------------------------

---POST /user/setChances ---------------------------------------
说明	: 设置玩家的机会数量。（将会覆盖目前玩家剩余的机会）
方式	: POST (x-www-urlencoded)
输入	: 
{
	'openID'	: (String) 微信用户识别码
	'chances'	: (Number) 要设置的机会数量
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 命令执行失败时的信息
	'data'		: --空--
}
----------------------------------------------------------------

2.2 奖品设置

---POST /prizes/addPrize ---------------------------------------
说明	: 新增一个奖品
方式	: POST (x-www-urlencoded)
输入	: 
{
	'name'				: (String) 礼物名字
	'percentage'		: (Number) 中奖概率(0~100%)
	'amount'			: (Number) 奖品数量
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 命令执行失败时的信息
	'data'		: --空--
}
备注：
不能重复新增相同名字的奖品。
----------------------------------------------------------------

---POST /prizes/findPrize --------------------------------------
说明	: 寻找奖品信息
方式	: POST (x-www-urlencoded)
输入	: 
{
	'name'				: (String) 已登记的奖品名字
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 命令执行失败时的信息
	'data'		: (JSONObject)
	{
		'name'	: (String) 奖品名字
		'initialPercentage': (Number) 中奖概率(0.0~1.0)
		'amount': (Number) 奖品数量
		'remainingAmount': (Number) 剩余数量
	}
}
----------------------------------------------------------------

---POST /prizes/deletePrize ------------------------------------
说明	: 删除一个奖品
方式	: POST (x-www-urlencoded)
输入	: 
{
	'name'		: (String) 已登记的奖品名字
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 命令执行失败时的信息
	'data'		: --空--
}
----------------------------------------------------------------

2.3 抽奖

---POST /lottery/startLottery ----------------------------------
说明	: 开始抽奖
方式	: POST (x-www-urlencoded)
输入	: 
{
	'openid'	: (String) 已登记的微信识别码(看2.1里的 /user/register)
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 服务器的信息
	'data'		: (JSONObject)
	{
		'won'	: (Boolean) 中奖了吗？(true为已中奖)
		'prize'	: (String) 奖品名字
	}
}

备注：
1. openid 必须要预先登记好
2. 该OpenID 被登记后将不能再次登记
----------------------------------------------------------------

2.4 登记获奖玩家

---POST /user/regWinner ----------------------------------------
说明	: 登记已中奖玩家的个人信息
方式	: POST (x-www-urlencoded)
输入	: 
{
	'openid'	: (String) 已中奖玩家的微信识别码
	'name'		: (String) 玩家名字
	'tel'		: (String) 玩家电话号码
}
返回	: (JSONObject)
{
	'success'	: (Boolean) 命令执行结果
	'message'	: (String) 服务器的信息
	'data'		: --无--
}

备注：
1. 玩家登陆信息后将不能再次登记。
-----------------------------------------------------------------

2.5 微信JSSDK调用

---GET /wx/ua ---------------------------------------------------
说明	: 调用微授权页面(获取用户同意码)
方式	: GET

备注:
运行后用户的浏览器将会跳到微信的授权页面
用户同意后将会跳转到wx/getToken来获取OpenID.
OpenID将会以Cookie方式传到用户。
请务必确认路径和网域名称跟服务器的位置一致。
-----------------------------------------------------------------
-----------------------------------------------------------------

# 3. 后台管理 ===================================================
本项目已经设置了后台主控台，以方便部署者随时查看数据库里的信息，
或者是实现管理者的简单后台管理功能。

登陆路径: /admin

*用户名和密码将会在另外一个渠道通知*

登陆后，管理者可以执行以下操作:
- 新增奖品
- 查看中奖者个人信息的名单
  *基于个人隐私，名单里不会包含微信识别号
- 设置微信JSSDK (包括登陆新AppID和Secret)

==================================================================

----------------------本文档完------------------------------------
最终修订: 17/12/2015
==================================================================